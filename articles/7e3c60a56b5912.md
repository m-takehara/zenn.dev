---
title: "Ktor ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’æ›¸ãã¨ãã« runBlocking ã™ã‚‹ãª"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kotlin", "ktor", "coroutine"]
published: true
---

## TL;DR

* Ktor ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ãŸã‚‰ postgres ã«ã¤ãªã„ã§ `pg_sleep(3)` ã™ã‚‹ã ã‘ã®ã‚¢ãƒ—ãƒªã‚’ä½œã£ãŸ
* `pg_sleep(3)` ã‚’ `runBlocking` ã§å›²ã†ã‹ `withContext` ã§å›²ã†ã‹ã«ã‚ˆã£ã¦ã€å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã—ãŸå ´åˆã®å®Ÿè¡Œæ™‚é–“ã«å·®ãŒå‡ºã‚‹
* `withContext` ã‚’ä½¿ãˆ

## ç¢ºèªæ–¹æ³•

ä»¥ä¸‹ã®ã‚ˆã†ãª Ktor ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ç”¨æ„ã—ã¦ã‚¢ãƒ—ãƒªã‚’å‹•ã‹ã™ã€‚  
â€» Ktor 2.3.11  
â€» Exposed 0.51.0  

ã“ã‚Œã§ http://localhost:8080/runblocking/3 ã¨ http://localhost:8080/withcontext/3 ãŒã§ãã‚‹ã€‚

```kotlin
fun Application.configureRouting() {
    Database.connect("jdbc:postgresql://localhost:5432/postgres", "org.postgresql.Driver", "postgres", "postgres")

    routing {
        get("/runblocking/{second}") {
            val second = call.parameters["second"]!!.toLong()
            runBlocking(Dispatchers.IO) {
                transaction {
                    exec("SELECT pg_sleep($second)")
                }
            }
            call.respond(HttpStatusCode.OK)
        }
        get("withcontext/{second}") {
            val second = call.parameters["second"]!!.toLong()
            withContext(Dispatchers.IO) {
                transaction {
                    exec("SELECT pg_sleep($second)")
                }
            }
            call.respond(HttpStatusCode.OK)
        }
    }
}
```

ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãŸã‚‰100ä¸¦åˆ—ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ãŸã„ã®ã§ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã€‚

ä»¥ä¸‹ã¿ãŸã„ãªæ„Ÿã˜ã§ withcontext.sh ã‚‚æ›¸ãã€‚

```shell
#!/usr/bin/env bash

URL="http://localhost:8080/runblocking/3"

for i in {1..100}
do
  curl -s "$URL" &
done
wait

echo "done"
```

ã§ããŸã‚‰ time ã‚’ä½¿ã£ã¦æ™‚é–“ã‚’æ¸¬ã‚ŠãªãŒã‚‰å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚

```shell
chmod +x ./runblocking.sh
time ./runblocking.sh
```

## å®Ÿè¡Œçµæœ

```
$ time ./runblocking.sh
done
./runblocking.sh  0.65s user 1.17s system 4% cpu 40.620 total
```

```
$ time ./withcontext.sh
done
./withcontext.sh  0.62s user 1.10s system 23% cpu 7.322 total
```

## ãªãœã“ã†ãªã‚‹ã‹

ã«ã¤ã„ã¦ã¯ ChatGPT (GPT-4o) ã«æ›¸ã‹ã›ã¦ã¿ãŸã€‚

> ãªãœã“ã†ãªã‚‹ã‹
> Kotlinã®runBlockingã¨withContextã¯ã€ã©ã¡ã‚‰ã‚‚éåŒæœŸã®ã‚³ãƒ¼ãƒ‰ã‚’åŒæœŸçš„ã«æ‰±ã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€ãã‚Œãã‚Œç•°ãªã‚‹å‹•ä½œã‚’ã—ã¾ã™ã€‚
> 
> runBlocking
> runBlockingã¯ã€éåŒæœŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€runBlockingã§å›²ã¾ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯ã€å‘¼ã³å‡ºã—å…ƒã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã€æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã®æ–¹æ³•ã§ã¯ã€ä»–ã®ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚„éåŒæœŸå‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã‚’å æœ‰ã—ã¦ã—ã¾ã„ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚„å¿œç­”æ€§ã«æ‚ªå½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
> 
> withContext
> ä¸€æ–¹ã€withContextã¯ã€éåŒæœŸã‚³ãƒ¼ãƒ‰ã‚’åˆ¥ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€ç¾åœ¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãã®å¾Œã«å‘¼ã³å‡ºã—å…ƒã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€withContextã¯ã€éåŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ãƒ¡ã‚¤ãƒ³ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã‚’å æœ‰ã™ã‚‹ã“ã¨ãªãã€ã‚ˆã‚ŠåŠ¹ç‡çš„ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚
> 
> ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãã‹
> runBlockingã¨withContextã®é¸æŠã¯ã€ãã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã©ã®ã‚ˆã†ãªå‹•ä½œãŒå¿…è¦ã‹ã«ä¾å­˜ã—ã¾ã™ã€‚ä¸€èˆ¬çš„ã«ã¯ã€éåŒæœŸå‡¦ç†ã‚’è¡Œã†å ´åˆã«ã¯withContextã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚ãªãœãªã‚‰ã€withContextã¯å‘¼ã³å‡ºã—å…ƒã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã›ãšã«éåŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚„å¿œç­”æ€§ã‚’æãªã†ã“ã¨ãªãã€ãƒªã‚½ãƒ¼ã‚¹ã‚’åŠ¹ç‡çš„ã«åˆ©ç”¨ã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚
> 
> ãŸã ã—ã€ç‰¹å®šã®ã‚·ãƒŠãƒªã‚ªã§ã¯ã€ä¸€æ™‚çš„ã«åŒæœŸå‡¦ç†ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®ã‚ˆã†ãªå ´åˆã«ã¯runBlockingã‚’ä½¿ç”¨ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€ãã®ä½¿ç”¨ã«ã¯æ…é‡ã•ãŒå¿…è¦ã§ã™ã€‚runBlockingã‚’èª¤ç”¨ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ãŒæ¯æ¸‡ã—ã€å¿œç­”æ€§ã®ä½ä¸‹ã‚„ãƒªã‚½ãƒ¼ã‚¹ã®ç„¡é§„é£ã„ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
> 
> ã—ãŸãŒã£ã¦ã€Ktorã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚’æ›¸ãéš›ã«ã¯ã€é€šå¸¸ã¯éåŒæœŸå‡¦ç†ã«withContextã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒé©åˆ‡ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚½ãƒ¼ã‚¹ã®åŠ¹ç‡çš„ãªåˆ©ç”¨ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¿œç­”æ€§ã®å‘ä¸ŠãŒå®Ÿç¾ã§ãã¾ã™ã€‚
> 
> çµè«–
> Kotlinã®runBlockingã¨withContextã¯ã€éåŒæœŸå‡¦ç†ã‚’åŒæœŸçš„ã«æ‰±ã†ãŸã‚ã®æ–¹æ³•ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã¾ã™ãŒã€ãã‚Œãã‚Œç•°ãªã‚‹å‹•ä½œã‚’ã—ã¾ã™ã€‚Ktorã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚’æ›¸ãéš›ã«ã¯ã€é€šå¸¸ã¯éåŒæœŸå‡¦ç†ã«withContextã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚½ãƒ¼ã‚¹ã®åŠ¹ç‡çš„ãªåˆ©ç”¨ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¿œç­”æ€§ã®å‘ä¸ŠãŒå®Ÿç¾ã§ãã¾ã™ã€‚
> 
> ä»¥ä¸ŠãŒã€runBlockingã¨withContextã®é¸æŠã«ã¤ã„ã¦ã®è©³ç´°ã§ã™ã€‚ã”è³ªå•ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ã©ã†ãã€‚

ã¨ã®ã“ã¨ã€‚

ãã‚‚ãã‚‚ Coroutine ã¨ã¯ã€ã¿ãŸã„ãªã¨ã“ã‚ã¯ã¨ã‚Šã‚ãˆãšä¸‹è¨˜ã‚’å‚ç…§ã€‚å€‹äººçš„ã«ã¯è¶…åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã€‚

https://speakerdeck.com/chimerast/kotlin-coroutines-to-ktor-http-client-dezuo-rusukerusurutasukushi-xing
